{"version":3,"sources":["Project.js"],"names":["async","projectDir","packagerPort","expoServerPort","await","ProjectSettings","readPackagerInfoAsync","currentStatus","projectRoot","url","UrlUtils","constructManifestUrlAsync","isUrlFallback","getManifestUrlWithFallbackAsync","ErrorCode","NO_PROJECT_ROOT","_assertValidProjectRoot","rangeStart","let","port","freeportAsync","NO_PORT_FOUND","_getFreePortAsync","platform","errorCode","minLength","getPlatformSpecificBundleUrl","fullUrl","response","request","get","headers","statusCode","body","JSON","parse","e","ProjectUtils","logError","undefined","message","length","_getForPlatformAsync","manifest","android","googleServicesFile","contents","fs","readFile","path","resolve","_resolveGoogleServicesFile","resolver","strict","assetSchemas","ExpSchema","getAssetSchemasAsync","sdkVersion","filter","fieldPath","_","urls","Promise","all","map","pathOrURL","match","existsSync","err","Error","localAssetPath","manifestField","forEach","index","set","logMethod","logWarning","_resolveManifestAssets","options","exp","pkg","readConfigJsonAsync","configName","configFilenameAsync","NO_PACKAGE_JSON","slug","name","INVALID_MANIFEST","getSlugAsync","formData","append","releaseChannel","queryResult","Api","callMethodAsync","getLatestReleaseAsync","publicUrl","assetUrl","outputDir","_validatePackagerReadyAsync","assetPathToWrite","join","ensureDir","bundlesPathToWrite","packagerOpts","isDev","dev","minify","iosBundle","androidBundle","_buildPublishBundlesAsync","iosBundleHash","crypto","createHash","update","digest","iosBundleUrl","iosJsPath","androidBundleHash","androidBundleUrl","androidJsPath","_writeArtifactSafelyAsync","logger","global","info","publishOptions","_getPublishExpConfigAsync","assets","_fetchAndSaveAssetsAsync","dumpAssetmap","assetmap","asset","hash","stringify","hooks","assetUrlOverride","publishedTime","Date","toISOString","commitTime","hashIds","uuid","v1","revisionId","encode","now","developer","tool","user","UserManager","ensureLoggedInAsync","id","username","bundleUrl","urljoin","dumpSourcemap","iosSourceMap","androidSourceMap","_maybeBuildSourceMapsAsync","force","iosMapName","iosMapPath","androidMapName","androidMapPath","truncateLastNLines","appendFile","debugHtml","exportForAppHosting","filePath","n","lines","readLastLines","read","to_vanquish","size","stat","truncate","paths","files","fileHashes","keyChunks","chunk","Object","keys","promises","key","logDebug","quiet","assetPath","p","copy","push","_saveAssetAsync","Analytics","logEvent","developerTool","Config","validationStatus","Doctor","validateWithNetworkAsync","ERROR","FATAL","PUBLISH_VALIDATION_ERROR","validPostPublishHooks","postPublish","hook","file","config","fn","_requireFromProject","error","_fn","HOOK_INITIALIZATION_ERROR","_fetchAndUploadAssetsAsync","_uploadArtifactsAsync","serverError","Sentry","captureException","_maybeWriteArtifactsToDiskAsync","ios","publishManifestPath","androidManifest","iosManifest","ExponentTools","getManifestAsync","Accept","hookOptions","log","msg","result","then","warn","stack","publishBundlePath","fullManifestUrl","replace","constantsPath","deleteLinesInFileAsync","regexFileAsync","isKernel","_handleKernelPublishedAsync","publishAsync","_createBlob","packagerInfo","startReactNativeServerAsync","reset","schema","joi","object","string","joiValidateAsync","INVALID_OPTIONS","toString","version","process","env","locales","getResolvedLocalesAsync","opts","entryPoint","Exp","determineEntryPointAsync","publishUrl","constructPublishUrlAsync","INVALID_BUNDLE","MINIMUM_BUNDLE_SIZE","sourceMapUrl","constructSourceMapUrlAsync","hostedAssetPrefix","assetsUrl","constructAssetsUrlAsync","iosAssetsJson","INVALID_ASSETS","androidAssetsJson","manifestAssets","absolutePath","md5hex","iosAssets","androidAssets","concat","_collectAssets","assetBundlePatterns","fullPatterns","bundledAssets","Set","shouldBundle","__packager_asset","some","minimatch","add","type","_configureExpForAssets","assetCdnPath","EXPO_CDN","uploadAssetsAsync","hostedUrl","keyName","artifactPath","artifact","pathToWrite","dirname","errorMsg","writeFile","publishSourceMapPath","kernelBundleUrl","api","scheme","host","kernel","androidManifestPath","iosManifestPath","metas","metadata","missing","exists","relativePath","_readFileForUpload","isNode","createReadStream","data","Blob","configPrefix","ThirdParty","getManifest","getConfigAsync","current","boolean","mode","any","valid","expIds","array","regex","bundleIdentifier","package","FORCE_TURTLE_VERSION","forceTurtleVersion","buildAsync","includes","delayAsync","_waitForRunningAsync","verbose","stopReactNativeServerAsync","Watchman","addToPathAsync","unblockAndGetVersionAsync","nodeModulesPath","customLogReporterPath","assetExts","nonPersistent","maxWorkers","Versions","gteSdkVersion","userPackagerOpts","uniq","cliOpts","reduce","val","defaultCliPath","cliPath","nodePath","rnCliPath","_nodePathForProjectRoot","packagerProcess","child_process","fork","cwd","REACT_NATIVE_APP_ROOT","NODE_PATH","ELECTRON_RUN_AS_NODE","silent","setPackagerInfoAsync","packagerPid","pid","on","treekill","stdout","setEncoding","stderr","pipe","split","_logPackagerOutput","exitPromise","reject","once","code","packagerUrl","constructBundleUrlAsync","urlType","hostType","statusUrl","timeoutPromise","setTimeout","WAIT_FOR_PACKAGER_TIMEOUT","race","treekillAsync","stopExpoServerAsync","app","express","use","bodyParser","json","limit","urlencoded","extended","manifestHandler","req","res","getPackagerOptsAsync","bundleUrlPackagerOpts","xde","shouldExposeEnvironmentVariableInManifest","mainModuleName","guessMainModulePath","queryParams","constructBundleQueryParamsAsync","hostname","encodeURI","encodeURIComponent","debuggerHost","constructDebuggerHostAsync","logUrl","constructLogUrlAsync","hostUri","constructHostUriAsync","hostUUID","UserSettings","anonymousIdentifier","currentSession","getSessionAsync","manifestString","_cachedSignedManifest","signedManifest","unsignedManifest","signature","publishInfo","getPublishInfoAsync","args","hostInfo","server","serverVersion","require","serverDriver","serverOS","os","serverOSVersion","release","send","status","post","deviceId","deviceName","_handleDeviceLogs","close","expRc","readExpRcAsync","manifestPort","listen","address","saveRecentExpRootAsync","startExpoServerAsync","hostnameAsync","ngrokPid","attempts","configPath","dotExpoHomeDirectory","ngrokConnectAsync","NGROK_ERROR","error_code","kill","ngrokKillAsync","resetProjectRandomnessAsync","_connectToNgrokAsync","getCurrentUsernameAsync","NO_PACKAGER_PORT","NO_EXPO_SERVER_PORT","stopTunnelsAsync","Android","startAdbReverseAsync","logInfo","packageShortName","base","startedTunnelsSuccessfully","TUNNEL_TIMEOUT","expoServerNgrokUrl","authtoken","ngrok","authToken","proto","randomness","manifestTunnelRandomness","getProjectRandomnessAsync","domainify","domain","packagerNgrokUrl","logWithLevel","tag","_expoEventType","addListener","startTunnelsAsync","ngrokProcess","ngrokProcessPid","removeAllListeners","stopAdbReverseAsync","number","integer","setOptionsAsync","getUrlAsync","offline","DevSession","startSession","startAsync","stopSession","_stopInternalAsync","stopAsync","promisify","validate","connect","Request","defaults","resolveWithFullResponse","modulePath","indexOf","fullPath","decache","_stripPackagerOutputBox","output","re","found","level","_isIgnorableDuplicateModuleWarning","test","startsWith","reactNativeNodeModulesPath","reactNativeNodeModulesPattern","escapeRegExp","reactNativeNodeModulesCollisionRegex","RegExp","_isIgnorableBugReportingExtraData","logs","i","obj","DEBUG","groupDepth","shouldHide","includesStack","directory","parentDirectory","delimiter","blacklistedEnvironmentVariables","has","toUpperCase"],"mappings":"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","file":"../Project.js","sourcesContent":["/**\n * @flow\n */\nimport bodyParser from 'body-parser';\nimport child_process from 'child_process';\nimport crypto from 'crypto';\nimport delayAsync from 'delay-async';\nimport decache from 'decache';\nimport express from 'express';\nimport freeportAsync from 'freeport-async';\nimport fs from 'fs-extra';\nimport HashIds from 'hashids';\nimport joi from 'joi';\nimport promisify from 'util.promisify';\nimport _ from 'lodash';\nimport minimatch from 'minimatch';\nimport ngrok from '@expo/ngrok';\nimport os from 'os';\nimport path from 'path';\nimport Request from 'request-promise-native';\nimport spawnAsync from '@expo/spawn-async';\nimport split from 'split';\nimport treekill from 'tree-kill';\nimport md5hex from 'md5hex';\nimport url from 'url';\nimport urljoin from 'url-join';\nimport uuid from 'uuid';\nimport readLastLines from 'read-last-lines';\n\nimport * as Analytics from './Analytics';\nimport * as Android from './Android';\nimport Api from './Api';\nimport Config from './Config';\nimport * as Doctor from './project/Doctor';\nimport * as DevSession from './DevSession';\nimport ErrorCode from './ErrorCode';\nimport logger from './Logger';\nimport * as ExponentTools from './detach/ExponentTools';\nimport * as Exp from './Exp';\nimport * as ExpSchema from './project/ExpSchema';\nimport FormData from './tools/FormData';\nimport { isNode } from './tools/EnvironmentHelper';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as ProjectUtils from './project/ProjectUtils';\nimport * as Sentry from './Sentry';\nimport * as ThirdParty from './ThirdParty';\nimport * as UrlUtils from './UrlUtils';\nimport UserManager from './User';\nimport UserSettings from './UserSettings';\nimport * as Versions from './Versions';\nimport * as Watchman from './Watchman';\nimport XDLError from './XDLError';\n\nimport type { User as ExpUser } from './User'; //eslint-disable-line\n\nconst EXPO_CDN = 'https://d1wp6m56sqw74a.cloudfront.net';\nconst MINIMUM_BUNDLE_SIZE = 500;\nconst TUNNEL_TIMEOUT = 10 * 1000;\nconst WAIT_FOR_PACKAGER_TIMEOUT = 30 * 1000;\n\nconst joiValidateAsync = promisify(joi.validate);\nconst treekillAsync = promisify(treekill);\nconst ngrokConnectAsync = promisify(ngrok.connect);\nconst ngrokKillAsync = promisify(ngrok.kill);\nconst stat = promisify(fs.stat);\nconst truncate = promisify(fs.truncate);\nconst appendFile = promisify(fs.appendFile);\n\nconst request = Request.defaults({\n  resolveWithFullResponse: true,\n});\n\ntype CachedSignedManifest = {\n  manifestString: ?string,\n  signedManifest: ?string,\n};\n\nlet _cachedSignedManifest: CachedSignedManifest = {\n  manifestString: null,\n  signedManifest: null,\n};\n\nexport type ProjectStatus = 'running' | 'ill' | 'exited';\n\nexport async function currentStatus(projectDir: string): Promise<ProjectStatus> {\n  const { packagerPort, expoServerPort } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n  if (packagerPort && expoServerPort) {\n    return 'running';\n  } else if (packagerPort || expoServerPort) {\n    return 'ill';\n  } else {\n    return 'exited';\n  }\n}\n\n// DECPRECATED: use UrlUtils.constructManifestUrlAsync\nexport async function getManifestUrlWithFallbackAsync(projectRoot: string) {\n  return {\n    url: await UrlUtils.constructManifestUrlAsync(projectRoot),\n    isUrlFallback: false,\n  };\n}\n\nasync function _assertValidProjectRoot(projectRoot) {\n  if (!projectRoot) {\n    throw new XDLError(ErrorCode.NO_PROJECT_ROOT, 'No project root specified');\n  }\n}\n\nasync function _getFreePortAsync(rangeStart) {\n  let port = await freeportAsync(rangeStart);\n  if (!port) {\n    throw new XDLError(ErrorCode.NO_PORT_FOUND, 'No available port found');\n  }\n\n  return port;\n}\n\nasync function _getForPlatformAsync(projectRoot, url, platform, { errorCode, minLength }) {\n  url = UrlUtils.getPlatformSpecificBundleUrl(url, platform);\n\n  let fullUrl = `${url}&platform=${platform}`;\n  let response = await request.get({\n    url: fullUrl,\n    headers: {\n      'Exponent-Platform': platform,\n    },\n  });\n\n  if (response.statusCode !== 200) {\n    if (response.body) {\n      let body;\n      try {\n        body = JSON.parse(response.body);\n      } catch (e) {\n        ProjectUtils.logError(projectRoot, 'expo', response.body);\n      }\n\n      if (body !== undefined) {\n        if (body.message) {\n          ProjectUtils.logError(projectRoot, 'expo', body.message);\n        } else {\n          ProjectUtils.logError(projectRoot, 'expo', response.body);\n        }\n      }\n    }\n    throw new XDLError(\n      errorCode,\n      `Packager URL ${fullUrl} returned unexpected code ${response.statusCode}. Please open your project in the Expo app and see if there are any errors. Also scroll up and make sure there were no errors or warnings when opening your project.`\n    );\n  }\n\n  if (!response.body || (minLength && response.body.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.body}`);\n  }\n\n  return response.body;\n}\n\nasync function _resolveGoogleServicesFile(projectRoot, manifest) {\n  if (manifest.android && manifest.android.googleServicesFile) {\n    const contents = await fs.readFile(\n      path.resolve(projectRoot, manifest.android.googleServicesFile),\n      'utf8'\n    );\n    manifest.android.googleServicesFile = contents;\n  }\n}\n\nasync function _resolveManifestAssets(projectRoot, manifest, resolver, strict = false) {\n  try {\n    // Asset fields that the user has set\n    const assetSchemas = (await ExpSchema.getAssetSchemasAsync(\n      manifest.sdkVersion\n    )).filter(({ fieldPath }) => _.get(manifest, fieldPath));\n\n    // Get the URLs\n    const urls = await Promise.all(\n      assetSchemas.map(async ({ fieldPath }) => {\n        const pathOrURL = _.get(manifest, fieldPath);\n        if (pathOrURL.match(/^https?:\\/\\/(.*)$/)) {\n          // It's a remote URL\n          return pathOrURL;\n        } else if (fs.existsSync(path.resolve(projectRoot, pathOrURL))) {\n          return await resolver(pathOrURL);\n        } else {\n          const err = new Error('Could not resolve local asset.');\n          // $FlowFixMe\n          err.localAssetPath = pathOrURL;\n          // $FlowFixMe\n          err.manifestField = fieldPath;\n          throw err;\n        }\n      })\n    );\n\n    // Set the corresponding URL fields\n    assetSchemas.forEach(({ fieldPath }, index) => _.set(manifest, fieldPath + 'Url', urls[index]));\n  } catch (e) {\n    let logMethod = ProjectUtils.logWarning;\n    if (strict) {\n      logMethod = ProjectUtils.logError;\n    }\n    if (e.localAssetPath) {\n      logMethod(\n        projectRoot,\n        'expo',\n        `Unable to resolve asset \"${e.localAssetPath}\" from \"${e.manifestField}\" in your app/exp.json.`\n      );\n    } else {\n      logMethod(\n        projectRoot,\n        'expo',\n        `Warning: Unable to resolve manifest assets. Icons might not work. ${e.message}.`\n      );\n    }\n\n    if (strict) {\n      throw new Error('Resolving assets failed.');\n    }\n  }\n}\n\nfunction _requireFromProject(modulePath, projectRoot) {\n  try {\n    if (modulePath.indexOf('.') === 0) {\n      let fullPath = path.resolve(projectRoot, modulePath);\n\n      // Clear the require cache for this module so get a fresh version of it\n      // without requiring the user to restart XDE\n      decache(fullPath);\n\n      // $FlowIssue: doesn't work with dynamic requires\n      return require(fullPath);\n    } else {\n      let fullPath = path.resolve(projectRoot, 'node_modules', modulePath);\n\n      // Clear the require cache for this module so get a fresh version of it\n      // without requiring the user to restart XDE\n      decache(fullPath);\n\n      // $FlowIssue: doesn't work with dynamic requires\n      return require(fullPath);\n    }\n  } catch (e) {\n    return null;\n  }\n}\n\nexport async function getSlugAsync(projectRoot: string, options: Object = {}) {\n  // Verify that exp/app.json exist\n  let { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  if (!exp || !pkg) {\n    const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n    throw new XDLError(\n      ErrorCode.NO_PACKAGE_JSON,\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  if (!exp.slug && pkg.name) {\n    exp.slug = pkg.name;\n  } else if (!exp.slug) {\n    const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n    throw new XDLError(\n      ErrorCode.INVALID_MANIFEST,\n      `${configName} in ${projectRoot} must contain the slug field`\n    );\n  }\n  return exp.slug;\n}\n\nexport async function getLatestReleaseAsync(\n  projectRoot: string,\n  options: {\n    releaseChannel: string,\n    platform: string,\n  }\n) {\n  // TODO(ville): move request from multipart/form-data to JSON once supported by the endpoint.\n  let formData = new FormData();\n  formData.append('queryType', 'history');\n  formData.append('slug', await getSlugAsync(projectRoot));\n  formData.append('version', '2');\n  formData.append('count', '1');\n  formData.append('releaseChannel', options.releaseChannel);\n  formData.append('platform', options.platform);\n  const { queryResult } = await Api.callMethodAsync('publishInfo', [], 'post', null, {\n    formData,\n  });\n  if (queryResult && queryResult.length > 0) {\n    return queryResult[0];\n  } else {\n    return null;\n  }\n}\n\n/**\n * Apps exporting for self hosting will have the files created in the project directory the following way:\n.\n android-index.json\n ios-index.json\n assets\n    1eccbc4c41d49fd81840aef3eaabe862\n bundles\n       android-01ee6e3ab3e8c16a4d926c91808d5320.js\n       ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n */\nexport async function exportForAppHosting(\n  projectRoot: string,\n  publicUrl: string,\n  assetUrl: string,\n  outputDir: string,\n  options: {} = {}\n) {\n  await _validatePackagerReadyAsync(projectRoot);\n\n  // make output dirs if not exists\n  const assetPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'assets'));\n  await fs.ensureDir(assetPathToWrite);\n  const bundlesPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'bundles'));\n  await fs.ensureDir(bundlesPathToWrite);\n\n  // build the bundles\n  let packagerOpts = {};\n  if (options.isDev) {\n    packagerOpts = { dev: true, minify: true };\n  }\n  const { iosBundle, androidBundle } = await _buildPublishBundlesAsync(projectRoot, packagerOpts);\n  const iosBundleHash = crypto\n    .createHash('md5')\n    .update(iosBundle)\n    .digest('hex');\n  const iosBundleUrl = `ios-${iosBundleHash}.js`;\n  const iosJsPath = path.join(outputDir, 'bundles', iosBundleUrl);\n\n  const androidBundleHash = crypto\n    .createHash('md5')\n    .update(androidBundle)\n    .digest('hex');\n  const androidBundleUrl = `android-${androidBundleHash}.js`;\n  const androidJsPath = path.join(outputDir, 'bundles', androidBundleUrl);\n\n  await _writeArtifactSafelyAsync(projectRoot, null, iosJsPath, iosBundle);\n  await _writeArtifactSafelyAsync(projectRoot, null, androidJsPath, androidBundle);\n  logger.global.info('Finished saving JS Bundles.');\n\n  // save the assets\n  // Get project config\n  const publishOptions = options.publishOptions || {};\n  const exp = await _getPublishExpConfigAsync(projectRoot, publishOptions);\n  const { assets } = await _fetchAndSaveAssetsAsync(projectRoot, exp, publicUrl, outputDir);\n\n  if (options.dumpAssetmap) {\n    logger.global.info('Dumping asset map.');\n    const assetmap = {};\n    assets.forEach(asset => {\n      assetmap[asset.hash] = asset;\n    });\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(outputDir, 'assetmap.json'),\n      JSON.stringify(assetmap)\n    );\n  }\n\n  // Delete keys that are normally deleted in the publish process\n  delete exp.hooks;\n\n  // Add assetUrl to manifest\n  exp.assetUrlOverride = assetUrl;\n\n  exp.publishedTime = new Date().toISOString();\n  exp.commitTime = new Date().toISOString();\n\n  // generate revisionId and id the same way www does\n  const hashIds = new HashIds(uuid.v1(), 10);\n  exp.revisionId = hashIds.encode(Date.now());\n\n  if (options.isDev) {\n    exp.developer = {\n      tool: 'exp',\n    };\n  }\n\n  if (!exp.slug) {\n    throw new XDLError(\n      ErrorCode.INVALID_MANIFEST,\n      'Must provide a slug field in the app.json manifest.'\n    );\n  }\n  const user = await UserManager.ensureLoggedInAsync();\n  exp.id = `@${user.username}/${exp.slug}`;\n\n  // save the android manifest\n  exp.bundleUrl = urljoin(publicUrl, 'bundles', androidBundleUrl);\n  exp.platform = 'android';\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'android-index.json'),\n    JSON.stringify(exp)\n  );\n\n  // save the ios manifest\n  exp.bundleUrl = urljoin(publicUrl, 'bundles', iosBundleUrl);\n  exp.platform = 'ios';\n  await _writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'ios-index.json'),\n    JSON.stringify(exp)\n  );\n\n  // build source maps\n  if (options.dumpSourcemap) {\n    const { iosSourceMap, androidSourceMap } = await _maybeBuildSourceMapsAsync(projectRoot, exp, {\n      force: true,\n    });\n    // write the sourcemap files\n    const iosMapName = `ios-${iosBundleHash}.map`;\n    const iosMapPath = path.join(outputDir, 'bundles', iosMapName);\n    await _writeArtifactSafelyAsync(projectRoot, null, iosMapPath, iosSourceMap);\n\n    const androidMapName = `android-${androidBundleHash}.map`;\n    const androidMapPath = path.join(outputDir, 'bundles', androidMapName);\n    await _writeArtifactSafelyAsync(projectRoot, null, androidMapPath, androidSourceMap);\n\n    // Remove original mapping to incorrect sourcemap paths\n    logger.global.info('Configuring sourcemaps');\n    await truncateLastNLines(iosJsPath, 1);\n    await truncateLastNLines(androidJsPath, 1);\n\n    // Add correct mapping to sourcemap paths\n    await appendFile(iosJsPath, `\\n//# sourceMappingURL=${iosMapName}`);\n    await appendFile(androidJsPath, `\\n//# sourceMappingURL=${androidMapName}`);\n\n    // Make a debug html so user can debug their bundles\n    logger.global.info('Preparing additional debugging files');\n    const debugHtml = `\n    <script src=\"${urljoin('bundles', iosBundleUrl)}\"></script>\n    <script src=\"${urljoin('bundles', androidBundleUrl)}\"></script>\n    Open up this file in Chrome. In the Javascript developer console, navigate to the Source tab.\n    You can see a red coloured folder containing the original source code from your bundle. \n    `;\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(outputDir, 'debug.html'),\n      debugHtml\n    );\n  }\n}\n\n// truncate the last n lines in a file\nasync function truncateLastNLines(filePath: string, n: number) {\n  const lines = await readLastLines.read(filePath, n);\n  const to_vanquish = lines.length;\n  const { size } = await stat(filePath);\n  await truncate(filePath, size - to_vanquish);\n}\n\nasync function _saveAssetAsync(projectRoot, assets, outputDir) {\n  // Collect paths by key, also effectively handles duplicates in the array\n  const paths = {};\n  assets.forEach(asset => {\n    asset.files.forEach((path, index) => {\n      paths[asset.fileHashes[index]] = path;\n    });\n  });\n\n  // save files one chunk at a time\n  const keyChunks = _.chunk(Object.keys(paths), 5);\n  for (const keys of keyChunks) {\n    const promises = [];\n    for (const key of keys) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `uploading ${paths[key]}`);\n\n      logger.global.info({ quiet: true }, `Saving ${paths[key]}`);\n\n      let assetPath = path.resolve(outputDir, 'assets', key);\n\n      // copy file over to assetPath\n      const p = fs.copy(paths[key], assetPath);\n      promises.push(p);\n    }\n    await Promise.all(promises);\n  }\n  logger.global.info('Files successfully saved.');\n}\n\nexport async function publishAsync(\n  projectRoot: string,\n  options: Object = {}\n): Promise<{ url: string, ids: string[], err: ?string }> {\n  const user = await UserManager.ensureLoggedInAsync();\n  await _validatePackagerReadyAsync(projectRoot);\n  Analytics.logEvent('Publish', {\n    projectRoot,\n    developerTool: Config.developerTool,\n  });\n\n  const validationStatus = await Doctor.validateWithNetworkAsync(projectRoot);\n  if (validationStatus == Doctor.ERROR || validationStatus === Doctor.FATAL) {\n    throw new XDLError(\n      ErrorCode.PUBLISH_VALIDATION_ERROR,\n      \"Couldn't publish because errors were found. (See logs above.) Please fix the errors and try again.\"\n    );\n  }\n\n  // Get project config\n  let exp = await _getPublishExpConfigAsync(projectRoot, options);\n\n  // TODO: refactor this out to a function, throw error if length doesn't match\n  let { hooks } = exp;\n  delete exp.hooks;\n  let validPostPublishHooks = [];\n  if (hooks && hooks.postPublish) {\n    hooks.postPublish.forEach(hook => {\n      let { file, config } = hook;\n      let fn = _requireFromProject(file, projectRoot);\n      if (fn === null) {\n        logger.global.error(`Unable to load postPublishHook: '${file}'`);\n      } else {\n        hook._fn = fn;\n        validPostPublishHooks.push(hook);\n      }\n    });\n\n    if (validPostPublishHooks.length !== hooks.postPublish.length) {\n      logger.global.error();\n\n      throw new XDLError(\n        ErrorCode.HOOK_INITIALIZATION_ERROR,\n        'Please fix your postPublish hook configuration.'\n      );\n    }\n  }\n\n  let { iosBundle, androidBundle } = await _buildPublishBundlesAsync(projectRoot);\n\n  await _fetchAndUploadAssetsAsync(projectRoot, exp);\n\n  let { iosSourceMap, androidSourceMap } = await _maybeBuildSourceMapsAsync(projectRoot, exp, {\n    force: validPostPublishHooks.length,\n  });\n\n  let response;\n  try {\n    response = await _uploadArtifactsAsync({\n      exp,\n      iosBundle,\n      androidBundle,\n      options,\n    });\n  } catch (e) {\n    if (e.serverError === 'SCHEMA_VALIDATION_ERROR') {\n      throw new Error(\n        `There was an error validating your project schema. Check for any warnings about the contents of your app/exp.json.`\n      );\n    }\n    Sentry.captureException(e);\n    throw e;\n  }\n\n  await _maybeWriteArtifactsToDiskAsync({\n    exp,\n    projectRoot,\n    iosBundle,\n    androidBundle,\n    iosSourceMap,\n    androidSourceMap,\n  });\n\n  if (\n    validPostPublishHooks.length ||\n    (exp.ios && exp.ios.publishManifestPath) ||\n    (exp.android && exp.android.publishManifestPath)\n  ) {\n    let [androidManifest, iosManifest] = await Promise.all([\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'android',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'ios',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n    ]);\n\n    const hookOptions = {\n      url: response.url,\n      exp,\n      iosBundle,\n      iosSourceMap,\n      iosManifest,\n      androidBundle,\n      androidSourceMap,\n      androidManifest,\n      projectRoot,\n      log: msg => {\n        logger.global.info({ quiet: true }, msg);\n      },\n    };\n\n    for (let hook of validPostPublishHooks) {\n      logger.global.info(`Running postPublish hook: ${hook.file}`);\n      try {\n        let result = hook._fn({\n          config: hook.config,\n          ...hookOptions,\n        });\n\n        // If it's a promise, wait for it to resolve\n        if (result && result.then) {\n          result = await result;\n        }\n\n        if (result) {\n          logger.global.info({ quiet: true }, result);\n        }\n      } catch (e) {\n        logger.global.warn(`Warning: postPublish hook '${hook.file}' failed: ${e.stack}`);\n      }\n    }\n\n    if (exp.ios && exp.ios.publishManifestPath) {\n      await _writeArtifactSafelyAsync(\n        projectRoot,\n        'ios.publishManifestPath',\n        exp.ios.publishManifestPath,\n        JSON.stringify(iosManifest)\n      );\n    }\n\n    if (exp.android && exp.android.publishManifestPath) {\n      await _writeArtifactSafelyAsync(\n        projectRoot,\n        'android.publishManifestPath',\n        exp.android.publishManifestPath,\n        JSON.stringify(androidManifest)\n      );\n    }\n\n    // We need to add EmbeddedResponse instances on Android to tell the runtime\n    // that the shell app manifest and bundle is packaged.\n    if (exp.android && exp.android.publishManifestPath && exp.android.publishBundlePath) {\n      let fullManifestUrl = `${response.url.replace('exp://', 'https://')}/index.exp`;\n      let constantsPath = path.join(\n        projectRoot,\n        'android',\n        'app',\n        'src',\n        'main',\n        'java',\n        'host',\n        'exp',\n        'exponent',\n        'generated',\n        'AppConstants.java'\n      );\n      await ExponentTools.deleteLinesInFileAsync(\n        `START EMBEDDED RESPONSES`,\n        `END EMBEDDED RESPONSES`,\n        constantsPath\n      );\n      await ExponentTools.regexFileAsync(\n        '// ADD EMBEDDED RESPONSES HERE',\n        `\n        // ADD EMBEDDED RESPONSES HERE\n        // START EMBEDDED RESPONSES\n        embeddedResponses.add(new Constants.EmbeddedResponse(\"${fullManifestUrl}\", \"assets://shell-app-manifest.json\", \"application/json\"));\n        embeddedResponses.add(new Constants.EmbeddedResponse(\"${androidManifest.bundleUrl}\", \"assets://shell-app.bundle\", \"application/javascript\"));\n        // END EMBEDDED RESPONSES`,\n        constantsPath\n      );\n    }\n  }\n\n  // TODO: move to postPublish hook\n  if (exp.isKernel) {\n    await _handleKernelPublishedAsync({\n      user,\n      exp,\n      projectRoot,\n      url: response.url,\n    });\n  }\n\n  return {\n    ...response,\n    url:\n      options.releaseChannel && options.releaseChannel !== 'default'\n        ? `${response.url}?release-channel=${options.releaseChannel}`\n        : response.url,\n  };\n}\n\nasync function _uploadArtifactsAsync({ exp, iosBundle, androidBundle, options }) {\n  logger.global.info('Uploading JavaScript bundles');\n  let formData = new FormData();\n\n  formData.append('expJson', JSON.stringify(exp));\n  formData.append('iosBundle', _createBlob(iosBundle), 'iosBundle');\n  formData.append('androidBundle', _createBlob(androidBundle), 'androidBundle');\n  formData.append('options', JSON.stringify(options));\n  let response = await Api.callMethodAsync('publish', null, 'put', null, {\n    formData,\n  });\n  return response;\n}\n\nasync function _validatePackagerReadyAsync(projectRoot) {\n  _assertValidProjectRoot(projectRoot);\n\n  // Ensure the packager is started\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    ProjectUtils.logWarning(\n      projectRoot,\n      'expo',\n      'Metro Bundler is not running. Trying to restart it...'\n    );\n    await startReactNativeServerAsync(projectRoot, { reset: true });\n  }\n}\n\nasync function _getPublishExpConfigAsync(projectRoot, options) {\n  let schema = joi.object().keys({\n    releaseChannel: joi.string(),\n  });\n\n  // Validate schema\n  try {\n    await joiValidateAsync(options, schema);\n    options.releaseChannel = options.releaseChannel || 'default'; // joi default not enforcing this :/\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n\n  // Verify that exp/app.json and package.json exist\n  let { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  if (!exp || !pkg) {\n    const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n    throw new XDLError(\n      ErrorCode.NO_PACKAGE_JSON,\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && pkg.version) {\n    exp.version = pkg.version;\n  }\n\n  if (!exp.slug && pkg.name) {\n    exp.slug = pkg.name;\n  }\n\n  if (exp.android && exp.android.config) {\n    delete exp.android.config;\n  }\n\n  if (exp.ios && exp.ios.config) {\n    delete exp.ios.config;\n  }\n\n  // Only allow projects to be published with UNVERSIONED if a correct token is set in env\n  if (exp.sdkVersion === 'UNVERSIONED' && !process.env['EXPO_SKIP_MANIFEST_VALIDATION_TOKEN']) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, 'Cannot publish with sdkVersion UNVERSIONED.');\n  }\n  exp.locales = await ExponentTools.getResolvedLocalesAsync(exp);\n  return exp;\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function _buildPublishBundlesAsync(projectRoot, opts?: Object) {\n  let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n  let publishUrl = await UrlUtils.constructPublishUrlAsync(projectRoot, entryPoint, null, opts);\n\n  logger.global.info('Building iOS bundle');\n  let iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: ErrorCode.INVALID_BUNDLE,\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  let androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: ErrorCode.INVALID_BUNDLE,\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  return { iosBundle, androidBundle };\n}\n\n// note(brentvatne): currently we build source map anytime there is a\n// postPublish hook -- we may have an option in the future to manually\n// enable sourcemap building, but for now it's very fast, most apps in\n// production should use sourcemaps for error reporting, and in the worst\n// case, adding a few seconds to a postPublish hook isn't too annoying\nasync function _maybeBuildSourceMapsAsync(projectRoot, exp, options = {}) {\n  if (!options.force) {\n    return { iosSourceMap: null, androidSourceMap: null };\n  }\n\n  let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n  let sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building sourcemaps');\n  let iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: ErrorCode.INVALID_BUNDLE,\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  let androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: ErrorCode.INVALID_BUNDLE,\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  return { iosSourceMap, androidSourceMap };\n}\n\n/**\n * Collects all the assets declared in the android app, ios app and manifest\n *\n * @param {string} hostedAssetPrefix\n *    The path where assets are hosted (ie) http://xxx.cloudfront.com/assets/\n * \n * @modifies {exp} Replaces relative asset paths in the manifest with hosted URLS\n * \n */\nasync function _collectAssets(projectRoot, exp, hostedAssetPrefix) {\n  let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n  let assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  let iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: ErrorCode.INVALID_ASSETS,\n  });\n\n  let androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: ErrorCode.INVALID_ASSETS,\n  });\n\n  // Resolve manifest assets to their hosted URL and add them to the list of assets to\n  // be uploaded. Modifies exp.\n  const manifestAssets = [];\n  await _resolveManifestAssets(\n    projectRoot,\n    exp,\n    async assetPath => {\n      const absolutePath = path.resolve(projectRoot, assetPath);\n      const contents = await fs.readFile(absolutePath);\n      const hash = md5hex(contents);\n      manifestAssets.push({ files: [absolutePath], fileHashes: [hash], hash });\n      return urljoin(hostedAssetPrefix, hash);\n    },\n    true\n  );\n\n  // Upload asset files\n  const iosAssets = JSON.parse(iosAssetsJson);\n  const androidAssets = JSON.parse(androidAssetsJson);\n  return iosAssets.concat(androidAssets).concat(manifestAssets);\n}\n\n/**\n * Configures exp, preparing it for asset export\n * \n * @modifies {exp}\n * \n */\nasync function _configureExpForAssets(projectRoot, exp, assets) {\n  // Add google services file if it exists\n  await _resolveGoogleServicesFile(projectRoot, exp);\n\n  // Convert asset patterns to a list of asset strings that match them.\n  // Assets strings are formatted as `asset_<hash>.<type>` and represent\n  // the name that the file will have in the app bundle. The `asset_` prefix is\n  // needed because android doesn't support assets that start with numbers.\n  if (exp.assetBundlePatterns) {\n    const fullPatterns = exp.assetBundlePatterns.map(p => path.join(projectRoot, p));\n    logger.global.info('Processing asset bundle patterns:');\n    fullPatterns.forEach(p => logger.global.info('- ' + p));\n    // The assets returned by the RN packager has duplicates so make sure we\n    // only bundle each once.\n    const bundledAssets = new Set();\n    for (const asset of assets) {\n      const file = asset.files && asset.files[0];\n      const shouldBundle =\n        asset.__packager_asset && file && fullPatterns.some(p => minimatch(file, p));\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `${shouldBundle ? 'Include' : 'Exclude'} asset ${file}`\n      );\n      if (shouldBundle) {\n        asset.fileHashes.forEach(hash =>\n          bundledAssets.add('asset_' + hash + (asset.type ? '.' + asset.type : ''))\n        );\n      }\n    }\n    exp.bundledAssets = [...bundledAssets];\n    delete exp.assetBundlePatterns;\n  }\n\n  return exp;\n}\n\nasync function _fetchAndUploadAssetsAsync(projectRoot, exp) {\n  logger.global.info('Analyzing assets');\n\n  const assetCdnPath = urljoin(EXPO_CDN, '~assets');\n  const assets = await _collectAssets(projectRoot, exp, assetCdnPath);\n\n  logger.global.info('Uploading assets');\n\n  if (assets.length > 0 && assets[0].fileHashes) {\n    await uploadAssetsAsync(projectRoot, assets);\n  } else {\n    logger.global.info({ quiet: true }, 'No assets to upload, skipped.');\n  }\n\n  // Updates the manifest to reflect additional asset bundling + configs\n  await _configureExpForAssets(projectRoot, exp, assets);\n\n  return exp;\n}\n\nasync function _fetchAndSaveAssetsAsync(projectRoot, exp, hostedUrl, outputDir) {\n  logger.global.info('Analyzing assets');\n\n  const assetCdnPath = urljoin(hostedUrl, 'assets');\n  const assets = await _collectAssets(projectRoot, exp, assetCdnPath);\n\n  logger.global.info('Saving assets');\n\n  if (assets.length > 0 && assets[0].fileHashes) {\n    await _saveAssetAsync(projectRoot, assets, outputDir);\n  } else {\n    logger.global.info({ quiet: true }, 'No assets to upload, skipped.');\n  }\n\n  // Updates the manifest to reflect additional asset bundling + configs\n  await _configureExpForAssets(projectRoot, exp, assets);\n\n  return { exp, assets };\n}\n\nasync function _writeArtifactSafelyAsync(projectRoot, keyName, artifactPath, artifact) {\n  const pathToWrite = path.resolve(projectRoot, artifactPath);\n  if (!fs.existsSync(path.dirname(pathToWrite))) {\n    const errorMsg = keyName\n      ? `app.json specifies: ${pathToWrite}, but that directory does not exist.`\n      : `app.json specifies ${keyName}: ${pathToWrite}, but that directory does not exist.`;\n    logger.global.warn(errorMsg);\n  } else {\n    await fs.writeFile(pathToWrite, artifact);\n  }\n}\n\nasync function _maybeWriteArtifactsToDiskAsync({\n  exp,\n  projectRoot,\n  iosBundle,\n  androidBundle,\n  iosSourceMap,\n  androidSourceMap,\n}) {\n  if (exp.android && exp.android.publishBundlePath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'android.publishBundlePath',\n      exp.android.publishBundlePath,\n      androidBundle\n    );\n  }\n\n  if (exp.ios && exp.ios.publishBundlePath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'ios.publishBundlePath',\n      exp.ios.publishBundlePath,\n      iosBundle\n    );\n  }\n\n  if (exp.android && exp.android.publishSourceMapPath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'android.publishSourceMapPath',\n      exp.android.publishSourceMapPath,\n      androidSourceMap\n    );\n  }\n\n  if (exp.ios && exp.ios.publishSourceMapPath) {\n    await _writeArtifactSafelyAsync(\n      projectRoot,\n      'ios.publishSourceMapPath',\n      exp.ios.publishSourceMapPath,\n      iosSourceMap\n    );\n  }\n}\n\nasync function _handleKernelPublishedAsync({ projectRoot, user, exp, url }) {\n  let kernelBundleUrl = `${Config.api.scheme}://${Config.api.host}`;\n  if (Config.api.port) {\n    kernelBundleUrl = `${kernelBundleUrl}:${Config.api.port}`;\n  }\n  kernelBundleUrl = `${kernelBundleUrl}/@${user.username}/${exp.slug}/bundle`;\n\n  if (exp.kernel.androidManifestPath) {\n    let manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'android',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.androidManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n\n  if (exp.kernel.iosManifestPath) {\n    let manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'ios',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.iosManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n}\n\n// TODO(jesse): Add analytics for upload\nasync function uploadAssetsAsync(projectRoot, assets) {\n  // Collect paths by key, also effectively handles duplicates in the array\n  const paths = {};\n  assets.forEach(asset => {\n    asset.files.forEach((path, index) => {\n      paths[asset.fileHashes[index]] = path;\n    });\n  });\n\n  // Collect list of assets missing on host\n  const metas = (await Api.callMethodAsync('assetsMetadata', [], 'post', {\n    keys: Object.keys(paths),\n  })).metadata;\n  const missing = Object.keys(paths).filter(key => !metas[key].exists);\n\n  if (missing.length === 0) {\n    logger.global.info({ quiet: true }, `No assets changed, skipped.`);\n  }\n\n  // Upload them!\n  await Promise.all(\n    _.chunk(missing, 5).map(async keys => {\n      let formData = new FormData();\n      for (const key of keys) {\n        ProjectUtils.logDebug(projectRoot, 'expo', `uploading ${paths[key]}`);\n\n        let relativePath = paths[key].replace(projectRoot, '');\n        logger.global.info({ quiet: true }, `Uploading ${relativePath}`);\n\n        formData.append(key, await _readFileForUpload(paths[key]), paths[key]);\n      }\n      await Api.callMethodAsync('uploadAssets', [], 'put', null, { formData });\n    })\n  );\n}\n\nfunction _createBlob(string) {\n  if (isNode()) {\n    return string;\n  } else {\n    return new Blob([string]);\n  }\n}\n\nasync function _readFileForUpload(path) {\n  if (isNode()) {\n    return fs.createReadStream(path);\n  } else {\n    const data = await fs.readFile(path);\n    return new Blob([data]);\n  }\n}\n\nasync function getConfigAsync(\n  projectRoot: string,\n  options: {\n    current?: boolean,\n    mode?: string,\n    platform?: string,\n    expIds?: Array<string>,\n    type?: string,\n    releaseChannel?: string,\n    bundleIdentifier?: string,\n    publicUrl?: string,\n  } = {}\n) {\n  if (!options.publicUrl) {\n    // get the manifest from the project directory\n    const { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n    const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n    return {\n      exp,\n      pkg,\n      configName: await ProjectUtils.configFilenameAsync(projectRoot),\n      configPrefix: configName === 'app.json' ? 'expo.' : '',\n    };\n  } else {\n    // get the externally hosted manifest\n    return {\n      exp: await ThirdParty.getManifest(options.publicUrl, options),\n      configName: options.publicUrl,\n      configPrefix: '',\n      pkg: {},\n    };\n  }\n}\n\nexport async function buildAsync(\n  projectRoot: string,\n  options: {\n    current?: boolean,\n    mode?: string,\n    platform?: string,\n    expIds?: Array<string>,\n    type?: string,\n    releaseChannel?: string,\n    bundleIdentifier?: string,\n    publicUrl?: string,\n  } = {}\n) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  let schema = joi.object().keys({\n    current: joi.boolean(),\n    mode: joi.string(),\n    platform: joi.any().valid('ios', 'android', 'all'),\n    expIds: joi.array(),\n    type: joi.any().valid('archive', 'simulator', 'client'),\n    releaseChannel: joi.string().regex(/[a-z\\d][a-z\\d._-]*/),\n    bundleIdentifier: joi.string().regex(/^[a-zA-Z][a-zA-Z0-9\\-\\.]+$/),\n    publicUrl: joi.string(),\n  });\n\n  try {\n    await joiValidateAsync(options, schema);\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n\n  const { exp, pkg, configName, configPrefix } = await getConfigAsync(projectRoot, options);\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      ErrorCode.NO_PACKAGE_JSON,\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.slug && pkg.name) {\n    exp.slug = pkg.name;\n  }\n\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        ErrorCode.INVALID_MANIFEST,\n        `Must specify a bundle identifier in order to build this experience for iOS. Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        ErrorCode.INVALID_MANIFEST,\n        `Must specify a java package in order to build this experience for Android. Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n\n  if (process.env.FORCE_TURTLE_VERSION) {\n    options.forceTurtleVersion = process.env.FORCE_TURTLE_VERSION;\n  }\n\n  let response = await Api.callMethodAsync('build', [], 'put', {\n    manifest: exp,\n    options,\n  });\n\n  return response;\n}\n\nasync function _waitForRunningAsync(url) {\n  try {\n    let response = await request(url);\n    // Looking for \"Cached Bundles\" string is hacky, but unfortunately\n    // ngrok returns a 200 when it succeeds but the port it's proxying\n    // isn't bound.\n    if (\n      response.statusCode >= 200 &&\n      response.statusCode < 300 &&\n      response.body &&\n      response.body.includes('packager-status:running')\n    ) {\n      return true;\n    }\n  } catch (e) {\n    // Try again after delay\n  }\n\n  await delayAsync(100);\n  return _waitForRunningAsync(url);\n}\n\nfunction _stripPackagerOutputBox(output: string) {\n  let re = /Running packager on port (\\d+)/;\n  let found = output.match(re);\n  if (found && found.length >= 2) {\n    return `Running packager on port ${found[1]}\\n`;\n  } else {\n    return null;\n  }\n}\n\nfunction _logPackagerOutput(projectRoot: string, level: string, data: Object) {\n  let output = data.toString();\n  if (!output) {\n    return;\n  }\n  // Temporarily hide warnings about duplicate providesModule declarations\n  // under react-native\n  if (_isIgnorableDuplicateModuleWarning(projectRoot, level, output)) {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `Suppressing @providesModule warning: ${output}`,\n      'project-suppress-providesmodule-warning'\n    );\n    return;\n  }\n  if (/^Scanning folders for symlinks in /.test(output)) {\n    ProjectUtils.logDebug(projectRoot, 'metro', output);\n    return;\n  }\n  if (level === 'info') {\n    ProjectUtils.logInfo(projectRoot, 'metro', output);\n  } else {\n    ProjectUtils.logError(projectRoot, 'metro', output);\n  }\n}\n\nfunction _isIgnorableDuplicateModuleWarning(\n  projectRoot: string,\n  level: string,\n  output: string\n): boolean {\n  if (\n    level !== 'error' ||\n    !output.startsWith('jest-haste-map: @providesModule naming collision:')\n  ) {\n    return false;\n  }\n\n  let reactNativeNodeModulesPath = path.join(\n    projectRoot,\n    'node_modules',\n    'react-native',\n    'node_modules'\n  );\n  let reactNativeNodeModulesPattern = _.escapeRegExp(reactNativeNodeModulesPath);\n  let reactNativeNodeModulesCollisionRegex = new RegExp(\n    `Paths: ${reactNativeNodeModulesPattern}.+ collides with ${reactNativeNodeModulesPattern}.+`\n  );\n  return reactNativeNodeModulesCollisionRegex.test(output);\n}\n\nfunction _isIgnorableBugReportingExtraData(body) {\n  return body.length === 2 && body[0] === 'BugReporting extraData:';\n}\n\nfunction _handleDeviceLogs(projectRoot: string, deviceId: string, deviceName: string, logs: any) {\n  for (let i = 0; i < logs.length; i++) {\n    let log = logs[i];\n    let body = typeof log.body === 'string' ? [log.body] : log.body;\n    let string = body\n      .map(obj => {\n        if (typeof obj === 'undefined') {\n          return 'undefined';\n        }\n        if (obj === 'null') {\n          return 'null';\n        }\n        if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {\n          return obj;\n        }\n        try {\n          return JSON.stringify(obj);\n        } catch (e) {\n          return obj.toString();\n        }\n      })\n      .join(' ');\n    let level = log.level;\n    if (_isIgnorableBugReportingExtraData(body)) {\n      level = logger.DEBUG;\n    }\n    let groupDepth = log.groupDepth;\n    let shouldHide = log.shouldHide;\n    let includesStack = log.includesStack;\n    ProjectUtils.logWithLevel(\n      projectRoot,\n      level,\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth,\n        shouldHide,\n        includesStack,\n      },\n      string\n    );\n  }\n}\nexport async function startReactNativeServerAsync(\n  projectRoot: string,\n  options: Object = {},\n  verbose: boolean = true\n) {\n  _assertValidProjectRoot(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  await Watchman.addToPathAsync(); // Attempt to fix watchman if it's hanging\n  await Watchman.unblockAndGetVersionAsync(projectRoot);\n\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n\n  let packagerPort = await _getFreePortAsync(19001); // Create packager options\n  let nodeModulesPath = exp.nodeModulesPath\n    ? path.join(path.resolve(projectRoot, exp.nodeModulesPath), 'node_modules')\n    : path.join(projectRoot, 'node_modules');\n  let packagerOpts = {\n    port: packagerPort,\n    customLogReporterPath: path.join(nodeModulesPath, 'expo', 'tools', 'LogReporter'),\n    assetExts: ['ttf'],\n    nonPersistent: !!options.nonPersistent,\n  };\n\n  if (options.maxWorkers) {\n    packagerOpts['max-workers'] = options.maxWorkers;\n  }\n\n  if (!Versions.gteSdkVersion(exp, '16.0.0')) {\n    delete packagerOpts.customLogReporterPath;\n  }\n  const userPackagerOpts = _.get(exp, 'packagerOpts');\n  if (userPackagerOpts) {\n    // The RN CLI expects rn-cli.config.js's path to be absolute. We use the\n    // project root to resolve relative paths since that was the original\n    // behavior of the RN CLI.\n    if (userPackagerOpts.config) {\n      userPackagerOpts.config = path.resolve(projectRoot, userPackagerOpts.config);\n    }\n\n    packagerOpts = {\n      ...packagerOpts,\n      ...userPackagerOpts,\n      ...(userPackagerOpts.assetExts\n        ? {\n            assetExts: _.uniq([...packagerOpts.assetExts, ...userPackagerOpts.assetExts]),\n          }\n        : {}),\n    };\n\n    if (userPackagerOpts.port !== undefined && userPackagerOpts.port !== null) {\n      packagerPort = userPackagerOpts.port;\n    }\n  }\n  let cliOpts = _.reduce(\n    packagerOpts,\n    (opts, val, key) => {\n      // If the packager opt value is boolean, don't set\n      // --[opt] [value], just set '--opt'\n      if (val && typeof val === 'boolean') {\n        opts.push(`--${key}`);\n      } else if (val) {\n        opts.push(`--${key}`, val);\n      }\n      return opts;\n    },\n    ['start']\n  );\n  if (options.reset) {\n    cliOpts.push('--reset-cache');\n  } // Get custom CLI path from project package.json, but fall back to node_module path\n  let defaultCliPath = path.join(\n    projectRoot,\n    'node_modules',\n    'react-native',\n    'local-cli',\n    'cli.js'\n  );\n  const cliPath = _.get(exp, 'rnCliPath', defaultCliPath);\n  let nodePath; // When using a custom path for the RN CLI, we want it to use the project // root to look up config files and Node modules\n  if (exp.rnCliPath) {\n    nodePath = _nodePathForProjectRoot(projectRoot);\n  } else {\n    nodePath = null;\n  }\n  // Run the copy of Node that's embedded in Electron by setting the // ELECTRON_RUN_AS_NODE environment variable // Note: the CLI script sets up graceful-fs and sets ulimit to 4096 in the // child process\n  let packagerProcess = child_process.fork(cliPath, cliOpts, {\n    cwd: projectRoot,\n    env: {\n      ...process.env,\n      REACT_NATIVE_APP_ROOT: projectRoot,\n      NODE_PATH: nodePath,\n      ELECTRON_RUN_AS_NODE: 1,\n    },\n    silent: true,\n  });\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort,\n    packagerPid: packagerProcess.pid,\n  }); // TODO: do we need this? don't know if it's ever called\n  process.on('exit', () => {\n    treekill(packagerProcess.pid);\n  });\n  packagerProcess.stdout.setEncoding('utf8');\n  packagerProcess.stderr.setEncoding('utf8');\n  packagerProcess.stdout.pipe(split()).on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'info', data);\n    }\n  });\n  packagerProcess.stderr.on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'error', data);\n    }\n  });\n  let exitPromise = new Promise((resolve, reject) => {\n    packagerProcess.once('exit', async code => {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Metro Bundler process exited with code ${code}`);\n      reject(new Error(`Metro Bundler process exited with code ${code}`));\n      try {\n        await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n          packagerPort: null,\n          packagerPid: null,\n        });\n      } catch (e) {}\n    });\n  });\n  let packagerUrl = await UrlUtils.constructBundleUrlAsync(projectRoot, {\n    urlType: 'http',\n    hostType: 'localhost',\n  });\n  const statusUrl = `${packagerUrl}/status`;\n  const timeoutPromise = new Promise((resolve, reject) =>\n    setTimeout(\n      () =>\n        reject(\n          new Error(\n            `Could not access packager status at ${statusUrl}. Are you sure the packager is running and reachable?`\n          )\n        ),\n      WAIT_FOR_PACKAGER_TIMEOUT\n    )\n  );\n  await Promise.race([_waitForRunningAsync(statusUrl), exitPromise, timeoutPromise]);\n} // Simulate the node_modules resolution // If you project dir is /Jesse/Expo/Universe/BubbleBounce, returns // \"/Jesse/node_modules:/Jesse/Expo/node_modules:/Jesse/Expo/Universe/node_modules:/Jesse/Expo/Universe/BubbleBounce/node_modules\"\nfunction _nodePathForProjectRoot(projectRoot: string): string {\n  let paths = [];\n  let directory = path.resolve(projectRoot);\n  while (true) {\n    paths.push(path.join(directory, 'node_modules'));\n    let parentDirectory = path.dirname(directory);\n    if (directory === parentDirectory) {\n      break;\n    }\n    directory = parentDirectory;\n  }\n  return paths.join(path.delimiter);\n}\nexport async function stopReactNativeServerAsync(projectRoot: string) {\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort || !packagerInfo.packagerPid) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `No packager found for project at ${projectRoot}.`);\n    return;\n  }\n  ProjectUtils.logDebug(\n    projectRoot,\n    'expo',\n    `Killing packager process tree: ${packagerInfo.packagerPid}`\n  );\n  try {\n    await treekillAsync(packagerInfo.packagerPid, 'SIGKILL');\n  } catch (e) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping packager process: ${e.toString()}`);\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort: null,\n    packagerPid: null,\n  });\n}\n\nlet blacklistedEnvironmentVariables = new Set([\n  'EXPO_ANDROID_KEY_PASSWORD',\n  'EXPO_ANDROID_KEYSTORE_PASSWORD',\n  'EXPO_IOS_DIST_P12_PASSWORD',\n  'EXPO_IOS_PUSH_P12_PASSWORD',\n]);\n\nfunction shouldExposeEnvironmentVariableInManifest(key) {\n  if (blacklistedEnvironmentVariables.has(key.toUpperCase())) {\n    return false;\n  }\n  return key.startsWith('REACT_NATIVE_') || key.startsWith('EXPO_');\n}\n\nexport async function startExpoServerAsync(projectRoot: string) {\n  _assertValidProjectRoot(projectRoot);\n  await stopExpoServerAsync(projectRoot);\n  let app = express();\n  app.use(\n    bodyParser.json({\n      limit: '10mb',\n    })\n  );\n  app.use(\n    bodyParser.urlencoded({\n      limit: '10mb',\n      extended: true,\n    })\n  );\n  if ((await Doctor.validateWithNetworkAsync(projectRoot)) === Doctor.FATAL) {\n    throw new Error(`Couldn't start project. Please fix the errors and restart the project.`);\n  } // Serve the manifest.\n  let manifestHandler = async (req, res) => {\n    try {\n      // We intentionally don't `await`. We want to continue trying even\n      // if there is a potential error in the package.json and don't want to slow\n      // down the request\n      Doctor.validateWithNetworkAsync(projectRoot);\n      let { exp: manifest } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n      if (!manifest) {\n        const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n        throw new Error(`No ${configName} file found`);\n      } // Get packager opts and then copy into bundleUrlPackagerOpts\n      let packagerOpts = await ProjectSettings.getPackagerOptsAsync(projectRoot);\n      let bundleUrlPackagerOpts = JSON.parse(JSON.stringify(packagerOpts));\n      bundleUrlPackagerOpts.urlType = 'http';\n      if (bundleUrlPackagerOpts.hostType === 'redirect') {\n        bundleUrlPackagerOpts.hostType = 'tunnel';\n      }\n      manifest.xde = true; // deprecated\n      manifest.developer = {\n        tool: Config.developerTool,\n        projectRoot,\n      };\n      manifest.packagerOpts = packagerOpts;\n      manifest.env = {};\n      for (let key of Object.keys(process.env)) {\n        if (shouldExposeEnvironmentVariableInManifest(key)) {\n          manifest.env[key] = process.env[key];\n        }\n      }\n      let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n      let platform = req.headers['exponent-platform'] || 'ios';\n      entryPoint = UrlUtils.getPlatformSpecificBundleUrl(entryPoint, platform);\n      let mainModuleName = UrlUtils.guessMainModulePath(entryPoint);\n      let queryParams = await UrlUtils.constructBundleQueryParamsAsync(\n        projectRoot,\n        packagerOpts,\n        req.hostname\n      );\n      let path = `/${encodeURI(mainModuleName)}.bundle?platform=${encodeURIComponent(\n        platform\n      )}&${queryParams}`;\n      manifest.bundleUrl =\n        (await UrlUtils.constructBundleUrlAsync(projectRoot, bundleUrlPackagerOpts, req.hostname)) +\n        path;\n      manifest.debuggerHost = await UrlUtils.constructDebuggerHostAsync(projectRoot, req.hostname);\n      manifest.mainModuleName = mainModuleName;\n      manifest.logUrl = await UrlUtils.constructLogUrlAsync(projectRoot, req.hostname);\n      manifest.hostUri = await UrlUtils.constructHostUriAsync(projectRoot, req.hostname);\n      await _resolveManifestAssets(\n        projectRoot,\n        manifest,\n        async path => manifest.bundleUrl.match(/^https?:\\/\\/.*?\\//)[0] + 'assets/' + path\n      ); // the server normally inserts this but if we're offline we'll do it here\n      await _resolveGoogleServicesFile(projectRoot, manifest);\n      const hostUUID = await UserSettings.anonymousIdentifier();\n      let currentSession = await UserManager.getSessionAsync();\n      if (!currentSession) {\n        manifest.id = `@anonymous/${manifest.slug}-${hostUUID}`;\n      }\n      let manifestString = JSON.stringify(manifest);\n      if (req.headers['exponent-accept-signature']) {\n        if (_cachedSignedManifest.manifestString === manifestString) {\n          manifestString = _cachedSignedManifest.signedManifest;\n        } else {\n          if (!currentSession) {\n            const unsignedManifest = {\n              manifestString,\n              signature: 'UNSIGNED',\n            };\n            _cachedSignedManifest.manifestString = manifestString;\n            manifestString = JSON.stringify(unsignedManifest);\n            _cachedSignedManifest.signedManifest = manifestString;\n          } else {\n            let publishInfo = await Exp.getPublishInfoAsync(projectRoot);\n            let signedManifest = await Api.callMethodAsync(\n              'signManifest',\n              [publishInfo.args],\n              'post',\n              manifest\n            );\n            _cachedSignedManifest.manifestString = manifestString;\n            _cachedSignedManifest.signedManifest = signedManifest.response;\n            manifestString = signedManifest.response;\n          }\n        }\n      }\n      const hostInfo = {\n        host: hostUUID,\n        server: 'xdl',\n        serverVersion: require('../package.json').version,\n        serverDriver: Config.developerTool,\n        serverOS: os.platform(),\n        serverOSVersion: os.release(),\n      };\n      res.append('Exponent-Server', JSON.stringify(hostInfo));\n      res.send(manifestString);\n      Analytics.logEvent('Serve Manifest', {\n        projectRoot,\n        developerTool: Config.developerTool,\n      });\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error in manifestHandler: ${e} ${e.stack}`); // 5xx = Server Error HTTP code\n      res.status(520).send({\n        error: e.toString(),\n      });\n    }\n  };\n  app.get('/', manifestHandler);\n  app.get('/manifest', manifestHandler);\n  app.get('/index.exp', manifestHandler);\n  app.post('/logs', async (req, res) => {\n    try {\n      let deviceId = req.get('Device-Id');\n      let deviceName = req.get('Device-Name');\n      if (deviceId && deviceName && req.body) {\n        _handleDeviceLogs(projectRoot, deviceId, deviceName, req.body);\n      }\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', `Error getting device logs: ${e} ${e.stack}`);\n    }\n    res.send('Success');\n  });\n  app.post('/shutdown', async (req, res) => {\n    server.close();\n    res.send('Success');\n  });\n  let expRc = await ProjectUtils.readExpRcAsync(projectRoot);\n  let expoServerPort = expRc.manifestPort ? expRc.manifestPort : await _getFreePortAsync(19000);\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort,\n  });\n  let server = app.listen(expoServerPort, () => {\n    let host = server.address().address;\n    let port = server.address().port;\n    ProjectUtils.logDebug(projectRoot, 'expo', `Local server listening at http://${host}:${port}`);\n  });\n  await Exp.saveRecentExpRootAsync(projectRoot);\n}\nexport async function stopExpoServerAsync(projectRoot: string) {\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerInfo && packagerInfo.expoServerPort) {\n    try {\n      await request.post(`http://localhost:${packagerInfo.expoServerPort}/shutdown`);\n    } catch (e) {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n  });\n}\nasync function _connectToNgrokAsync(\n  projectRoot: string,\n  args: mixed,\n  hostnameAsync: Function,\n  ngrokPid: ?number,\n  attempts: number = 0\n) {\n  try {\n    let configPath = path.join(UserSettings.dotExpoHomeDirectory(), 'ngrok.yml');\n    let hostname = await hostnameAsync();\n    let url = await ngrokConnectAsync({\n      hostname,\n      configPath,\n      ...args,\n    });\n    return url;\n  } catch (e) {\n    // Attempt to connect 3 times\n    if (attempts >= 2) {\n      if (e.message) {\n        throw new XDLError(ErrorCode.NGROK_ERROR, e.toString());\n      } else {\n        throw new XDLError(ErrorCode.NGROK_ERROR, JSON.stringify(e));\n      }\n    }\n    if (!attempts) {\n      attempts = 0;\n    } // Attempt to fix the issue\n    if (e.error_code && e.error_code === 103) {\n      if (attempts === 0) {\n        // Failed to start tunnel. Might be because url already bound to another session.\n        if (ngrokPid) {\n          try {\n            process.kill(ngrokPid, 'SIGKILL');\n          } catch (e) {\n            ProjectUtils.logDebug(projectRoot, 'expo', `Couldn't kill ngrok with PID ${ngrokPid}`);\n          }\n        } else {\n          await ngrokKillAsync();\n        }\n      } else {\n        // Change randomness to avoid conflict if killing ngrok didn't help\n        await Exp.resetProjectRandomnessAsync(projectRoot);\n      }\n    } // Wait 100ms and then try again\n    await delayAsync(100);\n    return _connectToNgrokAsync(projectRoot, args, hostnameAsync, null, attempts + 1);\n  }\n}\n\nexport async function startTunnelsAsync(projectRoot: string) {\n  let username = await UserManager.getCurrentUsernameAsync();\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    throw new XDLError(\n      ErrorCode.NO_PACKAGER_PORT,\n      `No packager found for project at ${projectRoot}.`\n    );\n  }\n  if (!packagerInfo.expoServerPort) {\n    throw new XDLError(\n      ErrorCode.NO_EXPO_SERVER_PORT,\n      `No Expo server found for project at ${projectRoot}.`\n    );\n  }\n  await stopTunnelsAsync(projectRoot);\n  if (await Android.startAdbReverseAsync(projectRoot)) {\n    ProjectUtils.logInfo(\n      projectRoot,\n      'expo',\n      'Successfully ran `adb reverse`. Localhost URLs should work on the connected Android device.'\n    );\n  }\n  let packageShortName = path.parse(projectRoot).base;\n  let expRc = await ProjectUtils.readExpRcAsync(projectRoot);\n\n  let startedTunnelsSuccessfully = false;\n\n  // Some issues with ngrok cause it to hang indefinitely. After\n  // TUNNEL_TIMEOUTms we just throw an error.\n  await Promise.race([\n    (async () => {\n      await delayAsync(TUNNEL_TIMEOUT);\n      if (!startedTunnelsSuccessfully) {\n        throw new Error('Starting tunnels timed out');\n      }\n    })(),\n    (async () => {\n      let expoServerNgrokUrl = await _connectToNgrokAsync(\n        projectRoot,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: packagerInfo.expoServerPort,\n          proto: 'http',\n        },\n        async () => {\n          let randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      let packagerNgrokUrl = await _connectToNgrokAsync(\n        projectRoot,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: packagerInfo.packagerPort,\n          proto: 'http',\n        },\n        async () => {\n          let randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            'packager',\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n        expoServerNgrokUrl,\n        packagerNgrokUrl,\n        ngrokPid: ngrok.process().pid,\n      });\n\n      startedTunnelsSuccessfully = true;\n\n      ProjectUtils.logWithLevel(\n        projectRoot,\n        'info',\n        {\n          tag: 'expo',\n          _expoEventType: 'TUNNEL_READY',\n        },\n        'Tunnel ready.'\n      );\n\n      ngrok.addListener('statuschange', status => {\n        if (status === 'reconnecting') {\n          ProjectUtils.logError(\n            projectRoot,\n            'expo',\n            'We noticed your tunnel is having issues. This may be due to intermittent problems with our tunnel provider. If you have trouble connecting to your app, try to Restart the project, or switch Host to LAN.'\n          );\n        } else if (status === 'online') {\n          ProjectUtils.logInfo(projectRoot, 'expo', 'Tunnel connected.');\n        }\n      });\n    })(),\n  ]);\n}\nexport async function stopTunnelsAsync(projectRoot: string) {\n  _assertValidProjectRoot(projectRoot); // This will kill all ngrok tunnels in the process. // We'll need to change this if we ever support more than one project // open at a time in XDE.\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  let ngrokProcess = ngrok.process();\n  let ngrokProcessPid = ngrokProcess ? ngrokProcess.pid : null;\n  ngrok.removeAllListeners('statuschange');\n  if (packagerInfo.ngrokPid && packagerInfo.ngrokPid !== ngrokProcessPid) {\n    // Ngrok is running in some other process. Kill at the os level.\n    try {\n      process.kill(packagerInfo.ngrokPid);\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Couldn't kill ngrok with PID ${packagerInfo.ngrokPid}`\n      );\n    }\n  } else {\n    // Ngrok is running from the current process. Kill using ngrok api.\n    await ngrokKillAsync();\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerNgrokUrl: null,\n    packagerNgrokUrl: null,\n    ngrokPid: null,\n  });\n  await Android.stopAdbReverseAsync(projectRoot);\n}\n\nexport async function setOptionsAsync(\n  projectRoot: string,\n  options: {\n    packagerPort?: number,\n  }\n) {\n  _assertValidProjectRoot(projectRoot); // Check to make sure all options are valid\n  let schema = joi.object().keys({\n    packagerPort: joi.number().integer(),\n  });\n  try {\n    await joiValidateAsync(options, schema);\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, options);\n}\nexport async function getUrlAsync(projectRoot: string, options: Object = {}) {\n  _assertValidProjectRoot(projectRoot);\n  return await UrlUtils.constructManifestUrlAsync(projectRoot, options);\n}\n\nexport async function startAsync(\n  projectRoot: string,\n  options: Object = {},\n  verbose: boolean = true\n): Promise<any> {\n  _assertValidProjectRoot(projectRoot);\n  Analytics.logEvent('Start Project', {\n    projectRoot,\n    developerTool: Config.developerTool,\n  });\n  await startExpoServerAsync(projectRoot);\n  await startReactNativeServerAsync(projectRoot, options, verbose);\n  if (!Config.offline) {\n    try {\n      await startTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error starting tunnel ${e.message}`);\n    }\n  }\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  DevSession.startSession(projectRoot, exp);\n  return exp;\n}\nasync function _stopInternalAsync(projectRoot: string): Promise<void> {\n  DevSession.stopSession();\n  await stopExpoServerAsync(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  if (!Config.offline) {\n    try {\n      await stopTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping ngrok ${e.message}`);\n    }\n  }\n}\nexport async function stopAsync(projectDir: string): Promise<void> {\n  const result = await Promise.race([\n    _stopInternalAsync(projectDir),\n    new Promise((resolve, reject) => setTimeout(resolve, 2000, 'stopFailed')),\n  ]);\n  if (result === 'stopFailed') {\n    // find RN packager and ngrok pids, attempt to kill them manually\n    const { packagerPid, ngrokPid } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n    if (packagerPid) {\n      try {\n        process.kill(packagerPid);\n      } catch (e) {}\n    }\n    if (ngrokPid) {\n      try {\n        process.kill(ngrokPid);\n      } catch (e) {}\n    }\n    await ProjectSettings.setPackagerInfoAsync(projectDir, {\n      expoServerPort: null,\n      packagerPort: null,\n      packagerPid: null,\n      expoServerNgrokUrl: null,\n      packagerNgrokUrl: null,\n      ngrokPid: null,\n    });\n  }\n}\n"],"sourceRoot":"/xdl@51.3.1/src"}